$(function(){
  var output = kechak.output = {};
  kechak.socket.on('message/output', function(message){
    output.message(message);
  });
  output.message = function(text){
    var message = $('<div/>').css({
                    'word-wrap' : 'break-word',
                    'width' : $('#output').width()
                  }).
                  html(output.filter.all(text));
    $('#output-border').after(message);  
  };
  output.filter = {};
  output.filter.all  = function(text){
    var response = text;
    $.each(['html', 'tiqav'], function(index, type){
      response = output.filter[type](response);
    });
    return response;
  };
  output.filter.html = function(text){
    return $("<div/>").text(text).html();
  };
  output.filter.tiqav  = function(text){
    var matches = text.match(output.expr.tiqavs) || [];
    $.each(matches, function(index, tiqav){
      var id = tiqav.match(output.expr.tiqav)[1];
      text = text.replace("[tiqav:"+id+"]", "<img src='http://tiqav.com/"+id+".jpg' height='180'/>");
    });
    return text;
  };
  output.expr        = {};
  output.expr.tiqav  = new RegExp(/\[tiqav:([a-zA-Z0-9]+)\]/);
  output.expr.tiqavs = new RegExp(/\[tiqav:([a-zA-Z0-9]+)\]/g);
});
